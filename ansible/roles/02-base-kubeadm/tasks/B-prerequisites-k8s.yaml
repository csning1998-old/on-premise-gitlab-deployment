---
- name: Block B. Run Kubernetes prerequisites setup
  block:
    - name: "Step 1. Enable bridge traffic modules"
      ansible.builtin.template:
        src: B-k8s_modules.j2
        dest: "{{ kubeadm_base.config_paths.modules }}"
        mode: "0644"
      notify: Load kernel modules

    - name: "Step 2. Set sysctl parameters"
      ansible.builtin.template:
        src: B-k8s_sysctl.conf.j2
        dest: "{{ kubeadm_base.config_paths.sysctl }}"
        mode: "0644"
      notify: Apply sysctl settings

    - name: "Step 3. Check if swap is active"
      ansible.builtin.command: swapon --show
      register: swapon_check
      changed_when: false
      failed_when: false

    - name: "Step 4. Disable swap if it is active"
      ansible.builtin.command: swapoff -a
      when: swapon_check.stdout != ""
      changed_when: true

    - name: "Step 5. Comment out swap entries in /etc/fstab"
      ansible.builtin.replace:
        path: /etc/fstab
        regexp: '^([^#].*?\sswap\s+.*)$'
        replace: '# \1'
