---
- name: "Block 0: Dynamically discover the Host-only network interface"
  block:
    - name: "Step 1. Find the NAT interface to exclude"
      ansible.builtin.shell:
        cmd: |
          set -o pipefail
          ip -o -4 addr show | grep 'inet {{ k8s_nat_subnet_prefix }}.' | awk '{print $2}'
        executable: /bin/bash
      register: nat_iface_result
      changed_when: false

    - name: "Step 2. Find the Host-only interface by excluding NAT and loopback"
      ansible.builtin.shell:
        cmd: |
          set -o pipefail
          ip -o link show | awk -F': ' '{print $2}' | grep -v -e '^lo$' -e '^{{ nat_iface_result.stdout }}$'
        executable: /bin/bash
      register: hostonly_iface_result
      changed_when: false

    - name: "Step 3. Set k8s_ha_interface fact for use in templates"
      ansible.builtin.set_fact:
        k8s_ha_interface: "{{ hostonly_iface_result.stdout }}"
      when: hostonly_iface_result.stdout | length > 0

    - name: "Step 4. Fail if Host-only interface could not be determined"
      ansible.builtin.fail:
        msg: "Could not dynamically determine the Host-Only network interface."
      when: k8s_ha_interface is not defined or k8s_ha_interface | length == 0

- name: "Block A: Install HAProxy and Keepalived packages"
  block:
    - name: "Step 1. Allow binding to non-local IP addresses"
      ansible.posix.sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        state: present
        reload: true
      loop: "{{ kubeadm_ha_lb.sysctl_settings }}"

    - name: "Step 2. Install Necessary Packages"
      ansible.builtin.apt:
        name: "{{ kubeadm_ha_lb.packages.apt }}"
        state: present
        update_cache: true

- name: "Block B: Configure Keepalived"
  block:
    - name: "Step 1. Ensure keepalived_script user exists for security context"
      ansible.builtin.user:
        name: "{{ item.name }}"
        system: "{{ item.system | default(omit) }}"
        shell: "{{ item.shell | default(omit) }}"
        state: present
      loop: "{{ kubeadm_ha_lb.users }}"

    - name: "Step 2. Configure Keepalived from template"
      ansible.builtin.template:
        src: keepalived.conf.j2
        dest: "{{ kubeadm_ha_lb.config_paths.keepalived }}"
        owner: root
        group: root
        mode: "0644"
      notify: Restart keepalived

    - name: "Step 3. Verify Keepalived configuration syntax"
      ansible.builtin.command: "keepalived --config-test -f {{ kubeadm_ha_lb.config_paths.keepalived }}"
      changed_when: false

- name: "Block C: Configure HAProxy"
  block:
    - name: "Step 1. Configure HAProxy from template"
      ansible.builtin.template:
        src: haproxy.cfg.j2
        dest: "{{ kubeadm_ha_lb.config_paths.haproxy }}"
        owner: root
        group: root
        mode: "0644"
      notify: Restart haproxy

    - name: "Step 2. Verify HAProxy configuration syntax"
      ansible.builtin.command: "haproxy -c -f {{ kubeadm_ha_lb.config_paths.haproxy }}"
      changed_when: false

- name: "Block D: Configure Logging"
  block:
    - name: "Step 1. Ensure rsyslog is configured for keepalived"
      ansible.builtin.lineinfile:
        path: "{{ kubeadm_ha_lb.config_paths.rsyslog }}"
        line: "{{ _kubeadm_ha_lb_rsyslog_line }}"
        create: true
        mode: "0644"
      notify: Restart rsyslog

    - name: "Step 2. Force handlers to run now for logging to take effect"
      # Meta task to ensure rsyslog is restarted before other services
      ansible.builtin.meta: flush_handlers

- name: "Block E: Ensure HA services are running"
  block:
    - name: "Ensure Keepalived and HAProxy services are enabled and started"
      # This final task ensures that regardless of changes, the services are running
      # before this role completes, making the VIP and Load Balancer available
      # for the next Play.
      ansible.builtin.systemd:
        name: "{{ item }}"
        state: started
        enabled: true
        daemon_reload: true # Reload systemd if config has changed
      loop: "{{ kubeadm_ha_lb.services }}"
