---
- name: "Block F: Unseal Vault Node Strategy"
  become: true
  when: inventory_hostname in groups['vault_leader'] or inventory_hostname in groups['vault_follower']
  block:
    - name: "F1. Check Current Vault Status"
      ansible.builtin.command: vault status -format=json
      environment:
        VAULT_ADDR: "https://127.0.0.1:{{ vault_port_api }}"
        VAULT_SKIP_VERIFY: "true"
      register: vault_status_check
      changed_when: false
      failed_when: false

    - name: "F2. [Standby] Wait for Vault to become Initialized (Raft Join)"
      ansible.builtin.command: vault status -format=json
      environment:
        VAULT_ADDR: "https://127.0.0.1:{{ vault_port_api }}"
        VAULT_SKIP_VERIFY: "true"
      register: vault_init_check
      until:
        - vault_init_check.rc == 2
        - (vault_init_check.stdout | from_json).initialized == true
      retries: "{{ vault_unseal_retries }}"
      delay: "{{ vault_unseal_delay_seconds }}"
      changed_when: false
      failed_when: false
      when:
        - inventory_hostname in groups['vault_follower']
        - vault_status_check.rc == 2
        - (vault_status_check.stdout | from_json).initialized == false

    - name: "F3. Fetch Unseal Keys from Bootstrap Vault"
      community.hashi_vault.vault_kv2_get:
        url: "{{ dev_vault_url }}"
        engine_mount_point: "secret"
        path: "{{ dev_vault_api_path }}"
        token: "{{ lookup('file', dev_root_token_path) }}"
        validate_certs: false
      register: bootstrap_secrets
      delegate_to: localhost
      become: false
      when:
        - (vault_init_check.changed is defined and vault_init_check.rc is defined and vault_init_check.rc == 2) or
          (vault_status_check.rc == 2 and (vault_status_check.stdout | from_json).sealed == true)

    - name: "F4. Parse Unseal Keys"
      ansible.builtin.set_fact:
        vault_unseal_keys: "{{ bootstrap_secrets.secret.prod_vault_unseal_keys }}"
      when: bootstrap_secrets is not skipped

    - name: "F5 Execute Unseal"
      ansible.builtin.command: "vault operator unseal {{ vault_unseal_keys[0] }}"
      environment:
        VAULT_ADDR: "https://127.0.0.1:{{ vault_port_api }}"
        VAULT_SKIP_VERIFY: "true"
      register: unseal_result
      changed_when: "'Sealed: false' in unseal_result.stdout"
      when: vault_unseal_keys is defined

    - name: "F6. Verify Unseal Status"
      ansible.builtin.debug:
        msg: "Vault node {{ inventory_hostname }} is successfully Unsealed."
      when: unseal_result is changed

- name: "Block G: Verify Vault Cluster Availability"
  become: true
  when: inventory_hostname in groups['vault_leader']
  block:
    - name: "Wait for Vault VIP to be Active (200 OK)"
      ansible.builtin.uri:
        url: "https://{{ vault_ha_virtual_ip }}:443/v1/sys/health"
        validate_certs: false
        status_code: 200
      when: inventory_hostname in groups['vault_leader']
      register: health_check
      until: health_check.status == 200
      retries: 60
      delay: 2
      delegate_to: localhost
      become: false
