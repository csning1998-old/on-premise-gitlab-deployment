---
- name: "Section A: Generate and place kubeconfig for the user"
  become: true
  block:
    - name: "Step A1. Create .kube directory for the SSH user"
      ansible.builtin.file:
        path: "/home/{{ ansible_ssh_user }}/.kube"
        state: directory
        owner: "{{ ansible_ssh_user }}"
        group: "{{ ansible_ssh_user }}"
        mode: "0750"

    - name: "Step A2. Generate kubeconfig from MicroK8s"
      ansible.builtin.command:
        cmd: "microk8s config"
      register: microk8s_config
      changed_when: false

    - name: "Step A3. Save kubeconfig to user's directory with correct permissions"
      ansible.builtin.copy:
        content: "{{ microk8s_config.stdout }}"
        dest: "/home/{{ ansible_ssh_user }}/.kube/config"
        owner: "{{ ansible_ssh_user }}"
        group: "{{ ansible_ssh_user }}"
        mode: "0600"

- name: "Section B: Upload Kubeconfig to Vault"
  run_once: true
  block:
    - name: "Step B1. Read kubeconfig from primary node"
      ansible.builtin.slurp:
        src: "/home/{{ ansible_ssh_user }}/.kube/config"
      register: remote_kubeconfig

    - name: "Step B2. Upload Kubeconfig to Vault KV"
      delegate_to: localhost
      become: false
      block:
        - name: Create temporary CA file for Vault
          ansible.builtin.tempfile:
            state: file
            suffix: .crt
          register: vault_ca_file

        - name: Write Vault CA to temp file
          ansible.builtin.copy:
            content: "{{ vault_ca_cert_b64 | b64decode }}"
            dest: "{{ vault_ca_file.path }}"
            mode: "0600"

        - name: Upload Kubeconfig to Vault KV
          community.hashi_vault.vault_kv2_write:
            url: "{{ vault_addr }}"
            path: "on-premise-gitlab-deployment/infrastructure/kubeconfig/{{ service_name }}"
            engine_mount_point: "secret"
            auth_method: approle
            role_id: "{{ vault_agent_role_id }}"
            secret_id: "{{ vault_agent_secret_id }}"
            validate_certs: true
            ca_cert: "{{ vault_ca_file.path }}"
            data:
              content_b64: "{{ remote_kubeconfig['content'] }}"
      always:
        - name: Clean up temporary Vault CA file
          ansible.builtin.file:
            path: "{{ vault_ca_file.path }}"
            state: absent
          when: vault_ca_file.path is defined
