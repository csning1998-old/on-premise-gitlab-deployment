---
- name: "Block E: Initialize Vault Cluster (Primary Only)"
  become: true
  run_once: true
  block:
    - name: "E1. Wait for Vault"
      ansible.builtin.wait_for:
        port: "{{ vault_port_api }}"
        delay: "{{ vault_wait_delay_seconds }}"

    - name: "E2. Initialize Vault"
      ansible.builtin.command: >
        vault operator init \
        -key-shares={{ vault_init_key_shares }} \
        -key-threshold={{ vault_init_key_threshold }} \
        -format=json
      environment:
        VAULT_ADDR: "https://127.0.0.1:{{ vault_port_api }}"
        VAULT_SKIP_VERIFY: "true"
      register: init_result
      ignore_errors: true

    - name: "E3. Read existing Infrastructure Secrets"
      community.hashi_vault.vault_kv2_get:
        url: "{{ dev_vault_url }}"
        engine_mount_point: "secret"
        path: "{{ dev_vault_api_path }}"
        token: "{{ lookup('file', dev_root_token_path) }}"
        validate_certs: false
      register: existing_secrets
      delegate_to: localhost
      become: false
      ignore_errors: true

    - name: "E4. Write Merged Secrets back to Vault"
      community.hashi_vault.vault_kv2_write:
        url: "{{ dev_vault_url }}"
        engine_mount_point: "secret"
        path: "{{ dev_vault_api_path }}"
        token: "{{ lookup('file', dev_root_token_path) }}"
        validate_certs: false
        data: >-
          {{ 
            (existing_secrets.secret | default({})) 
            | combine({
                'prod_vault_root_token': (init_result.stdout | from_json).root_token,
                'prod_vault_unseal_keys': (init_result.stdout | from_json).unseal_keys_b64
              }) 
          }}
      delegate_to: localhost
      become: false
      when: init_result.rc == 0
