---
- name: "Block A: Install Golang"
  become: true
  block:
    - name: "Step A1. Update apt cache"
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

    - name: "Step A2. Install Golang packages"
      ansible.builtin.apt:
        name: "{{ minio_base.go_package }}"
        state: present

- name: "Block B: Install MinIO via Go"
  become: true
  block:
    - name: "Step B1. Install MinIO from source (github.com/minio/minio@{{ minio_base.release_version }})"
      ansible.builtin.command:
        cmd: "/usr/bin/go install github.com/minio/minio@{{ minio_base.release_version }}"
      environment:
        GOPATH: "/root/go"
      register: go_install_result
      changed_when: true

    - name: "Step B2. Move MinIO binary to system path"
      ansible.builtin.command:
        cmd: "mv /root/go/bin/minio {{ minio_base.install_path }}"
        creates: "{{ minio_base.install_path }}"

    - name: "Step B3. Ensure binary is executable"
      ansible.builtin.file:
        path: "{{ minio_base.install_path }}"
        mode: "0755"
        owner: root
        group: root

    - name: "Step B4. Download MinIO Client"
      ansible.builtin.get_url:
        url: "https://dl.min.io/client/mc/release/linux-amd64/mc"
        dest: "/usr/local/bin/mc"
        mode: "0755"
        owner: root
        group: root

    - name: "Step B5. Verify mc installation"
      ansible.builtin.command: mc --version
      register: mc_version
      changed_when: false

    - name: "Step B6. Print mc version"
      ansible.builtin.debug:
        msg: "MinIO Client installed: {{ mc_version.stdout }}"

- name: "Block C: System Configuration"
  become: true
  block:
    - name: "Step C1. Create MinIO group"
      ansible.builtin.group:
        name: "{{ minio_base.group }}"
        state: present
        system: true

    - name: "Step C2. Create MinIO user"
      ansible.builtin.user:
        name: "{{ minio_base.user }}"
        group: "{{ minio_base.group }}"
        system: true
        shell: /sbin/nologin
        create_home: false

    - name: "Step C3. Create Data Directory"
      ansible.builtin.file:
        path: "{{ minio_base.data_dir }}"
        state: directory
        owner: "{{ minio_base.user }}"
        group: "{{ minio_base.group }}"
        mode: "0750"

    - name: "Step C4. Create Configuration Directory"
      ansible.builtin.file:
        path: "{{ minio_base.config_dir }}"
        state: directory
        owner: "{{ minio_base.user }}"
        group: "{{ minio_base.group }}"
        mode: "0750"

    - name: "Step C5. Create Systemd Service file"
      ansible.builtin.template:
        src: minio.service.j2
        dest: /etc/systemd/system/minio.service
        owner: root
        group: root
        mode: "0644"

    - name: "Step C6. Disable MinIO service (for Packer image)"
      ansible.builtin.systemd:
        name: minio
        enabled: false
        state: stopped
