---
- name: "Section A: Configure Vault Agent for PKI Rotation"
  become: true
  block:
    - name: "Step A0. Ensure Vault Binary is installed"
      ansible.builtin.include_role:
        name: 07-base-vault
      vars:
        vault_install_only: true

    - name: "Step A1. Ensure Service Domain resolves to Localhost"
      ansible.builtin.lineinfile:
        path: /etc/hosts
        line: "127.0.0.1 {{ dev_harbor_service_domain }}"
        state: present

    - name: "Step A2. Create Vault Agent Config Directory"
      ansible.builtin.file:
        path: "{{ vault_agent_config_dir }}/approle"
        state: directory
        owner: vault
        group: vault
        mode: "0750"

    - name: "Step A3. Write AppRole Credentials"
      ansible.builtin.copy:
        content: "{{ item.content }}"
        dest: "{{ vault_agent_config_dir }}/approle/{{ item.file }}"
        owner: vault
        group: vault
        mode: "0600"
      loop:
        - { file: "role_id", content: "{{ vault_agent_role_id }}" }
        - { file: "secret_id", content: "{{ vault_agent_secret_id }}" }
      no_log: true

    - name: "Step A4. Deploy Vault CA Certificate"
      ansible.builtin.copy:
        content: "{{ vault_ca_cert_b64 | b64decode }}"
        dest: "{{ vault_agent_config_dir }}/vault-ca.crt"
        owner: vault
        group: vault
        mode: "0644"

    - name: "Step A5. Ensure Harbor PKI Directory Exists"
      ansible.builtin.file:
        path: "{{ harbor_pki_dir }}"
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: "Step A6. Configure Vault Agent (vault-agent.hcl)"
      ansible.builtin.template:
        src: vault-agent.hcl.j2
        dest: "{{ vault_agent_config_dir }}/vault-agent.hcl"
        owner: vault
        group: vault
        mode: "0640"
      notify: Restart Vault Agent

    - name: "Step A7. Configure Vault Agent Service"
      ansible.builtin.template:
        src: vault-agent.service.j2
        dest: /etc/systemd/system/vault-agent.service
        owner: root
        group: root
        mode: "0644"
      notify: Restart Vault Agent

    - name: "Step A8. Start Vault Agent and Wait for Certs"
      ansible.builtin.systemd:
        name: vault-agent
        state: started
        enabled: true
        daemon_reload: true

    - name: "Step A9. Wait for Certificate Generation"
      ansible.builtin.wait_for:
        path: "{{ harbor_cert_path }}"
        timeout: 60
        msg: "Timeout waiting for Vault Agent to generate Harbor certificates."

- name: "Section B: Fetch Secrets from Vault"
  become: true
  block:
    - name: "Step B1. Retrieve Harbor Credentials"
      community.hashi_vault.vault_kv2_get:
        url: "{{ vault_address }}"
        path: "on-premise-gitlab-deployment/dev-harbor/app"
        engine_mount_point: "secret"
        auth_method: approle
        role_id: "{{ vault_agent_role_id }}"
        secret_id: "{{ vault_agent_secret_id }}"
        ca_cert: "{{ vault_agent_config_dir }}/vault-ca.crt"
      register: harbor_vault_secrets
      no_log: true

- name: "Section C: Configure Harbor"
  become: true
  block:
    - name: "Step C1. Render harbor.yml"
      ansible.builtin.template:
        src: harbor.yml.j2
        dest: "{{ harbor_install_dir }}/harbor.yml"
        mode: "0644"
      register: harbor_system_config_status

    - name: "Step C2. Run Install Script (First Time Only)"
      ansible.builtin.command:
        cmd: "./install.sh --with-trivy"
        chdir: "{{ harbor_install_dir }}"
      args:
        creates: "{{ harbor_install_dir }}/docker-compose.yml"

    - name: "Step C3. Reconfigure Harbor (If Config Changed)"
      ansible.builtin.shell:
        cmd: |
          docker compose down -v
          ./prepare
          docker compose up -d
        chdir: "{{ harbor_install_dir }}"
      when:
        - harbor_system_config_status.changed
        - not (ansible_check_mode | bool)

- name: "Section D: Verification"
  block:
    - name: "Step D1. Wait for Harbor Health (HTTPS)"
      ansible.builtin.uri:
        url: "https://127.0.0.1/api/v2.0/health"
        validate_certs: false
        status_code: 200
        return_content: yes
      register: result
      until: result.status == 200
      retries: 30
      delay: 10
