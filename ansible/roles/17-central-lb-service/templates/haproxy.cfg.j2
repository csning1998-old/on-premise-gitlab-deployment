global
    log /dev/log    local0
    log /dev/log    local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

    # Default SSL material locations
    ca-base /etc/ssl/certs
    crt-base /etc/ssl/private

defaults
    log     global
    mode    tcp
    option  tcplog
    option  dontlognull
    timeout connect 5000
    timeout client  50000
    timeout server  50000

# Stats Interface, only bind to management IP
listen stats
    bind {{ ansible_host }}:{{ haproxy_stats_port }} ssl crt /etc/haproxy/certs/vault.pem
    mode http
    stats enable
    stats uri /
    stats refresh 10s
    stats auth {{ haproxy_stats_user }}:{{ haproxy_stats_pass }}
    stats admin if TRUE

{# Service Port Mapping #}
{% for segment in lb_service_segments %}
# --- Service: {{ segment.name }} ---
{% for port_name, port_cfg in segment.ports.items() %}

# Frontend for {{ port_name }}
frontend fe_{{ segment.name | replace('-', '_') }}_{{ port_name }}
    {# If Vault then TCP Passthrough (no ssl crt), else if Health Check then HTTPS (check-ssl) #}
    {% if port_cfg.frontend == 443 and vault_haproxy_bundle is defined and segment.name != 'vault' %}
    bind {{ segment.vip }}:{{ port_cfg.frontend }} ssl crt /etc/haproxy/certs/vault.pem
    {% else %}
    {# Fix: Force MSS clamping to 1400 to prevent packet drops in Overlay Networks (e.g. TLS Server Hello) #}
    bind {{ segment.vip }}:{{ port_cfg.frontend }} mss 1400
    {% endif %}
    mode tcp
    option tcplog
    default_backend be_{{ segment.name | replace('-', '_') }}_{{ port_name }}

# Backend for {{ port_name }} (Saturation Slots)
backend be_{{ segment.name | replace('-', '_') }}_{{ port_name }}
    mode tcp
    balance roundrobin

    {# Dynamic Health Check Logic #}
    {% if port_cfg.health_check_type == 'http' %}
    option httpchk GET {{ port_cfg.health_check_http_path | default('/') }}
    http-check expect {{ port_cfg.health_check_http_expect | default('status 200') }}
    {% else %}
    option tcp-check
    {% endif %}

    {% for server in segment.backend_servers %}
    {# If Vault then TCP Passthrough (no ssl), else if Health Check then HTTPS (check-ssl) #}
    {% if segment.name == 'vault' %}
    server {{ server.name }} {{ server.ip }}:{{ port_cfg.backend }} check inter 3s fall 3 rise 2 check-ssl verify none
    {% else %}
    server {{ server.name }} {{ server.ip }}:{{ port_cfg.backend }} check inter 3s fall 3 rise 2{{ ' ssl verify none' if port_cfg.health_check_ssl | default(false) else '' }}
    {% endif %}
    {% endfor %}

{% endfor %}
{% endfor %}