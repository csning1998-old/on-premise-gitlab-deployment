---
- name: "Section A: Deploy SSL Certificates"
  become: true
  block:
    - name: "Step A1. Ensure Certificate Directory Exists"
      ansible.builtin.file:
        path: /etc/haproxy/certs
        state: directory
        owner: haproxy
        group: haproxy
        mode: "0700"

    - name: "Step A2. Deploy Vault HAProxy Bundle (Cert + Key)"
      ansible.builtin.copy:
        content: "{{ vault_haproxy_bundle | b64decode }}"
        dest: /etc/haproxy/certs/vault.pem
        owner: haproxy
        group: haproxy
        mode: "0600"
      when: vault_haproxy_bundle is defined
      notify: Restart HAProxy

    - name: "Step A3. Deploy Root CA (For Backend Verification)"
      ansible.builtin.copy:
        content: "{{ vault_ca_cert | b64decode }}"
        dest: /etc/haproxy/certs/ca.crt
        owner: haproxy
        group: haproxy
        mode: "0644"
      when: vault_ca_cert is defined
      notify: Restart HAProxy

- name: "Section B: Configure Keepalived and HAProxy"
  block:
    - name: "Step B1. Render Keepalived configuration"
      ansible.builtin.template:
        src: keepalived.conf.j2
        dest: /etc/keepalived/keepalived.conf
        owner: root
        group: root
        mode: "0644"
      notify: Restart Keepalived

    - name: "Step B2. Render HAProxy configuration"
      ansible.builtin.template:
        src: haproxy.cfg.j2
        dest: /etc/haproxy/haproxy.cfg
        owner: root
        group: root
        mode: "0640"
      notify: Restart HAProxy

    - name: "Step B3. Verify HAProxy configuration"
      ansible.builtin.command:
        cmd: haproxy -c -f /etc/haproxy/haproxy.cfg
      changed_when: false

- name: "Section C: Service Lifecycle"
  block:
    - name: "Step C1. Enable and start Keepalived"
      ansible.builtin.systemd:
        name: keepalived
        state: started
        enabled: true
        daemon_reload: true

    - name: "Step C2. Enable and start HAProxy"
      ansible.builtin.systemd:
        name: haproxy
        state: started
        enabled: true
        daemon_reload: true
