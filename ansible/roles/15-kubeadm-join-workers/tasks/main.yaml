---
- name: "Section A: Prepare worker node for joining"
  block:
    - name: "Step 1. Reset any previous kubeadm configuration"
      ansible.builtin.command:
        cmd: "{{ kubeadm_join_worker.prereqs.reset_cmd }}"
      changed_when: true

    - name: "Step 2. Ensure kubelet service is enabled and started"
      ansible.builtin.systemd:
        name: "{{ kubeadm_join_worker.prereqs.service_name }}"
        state: started
        enabled: true

- name: "Section B: Join this worker node to the cluster"
  block:
    - name: "Step 0. Create kubeadm join config file from template"
      ansible.builtin.template:
        src: kubeadm-join-config.yaml.j2
        dest: "{{ kubeadm_join_worker.join_config.dest_path }}"
        mode: "{{ kubeadm_join_worker.join_config.mode }}"

    - name: "Step 1. Execute the worker join command"
      ansible.builtin.command: >-
        kubeadm join {{ _kubeadm_join_cli_args_string }}
      args:
        creates: "{{ kubeadm_join_worker.join_cmd.creates_path }}"
      register: kubeadm_join_result

    - name: "Step 2. Fail if kubeadm join command failed"
      ansible.builtin.fail:
        msg: |
          {{ kubeadm_join_worker.join_cmd.fail_msg }}
          STDOUT: {{ kubeadm_join_result.stdout | default('N/A') }}
          STDERR: {{ kubeadm_join_result.stderr | default('N/A') }}
      when: kubeadm_join_result.rc is defined and kubeadm_join_result.rc != 0
