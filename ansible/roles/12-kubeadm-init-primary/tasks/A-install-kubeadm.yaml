---
- name: "Block A: Prepare primary master node for initialization"
  block:
    - name: "Step 1. Set advertise_ip fact for this node"
      ansible.builtin.set_fact:
        advertise_ip: "{{ k8s_master_ips[0] }}"

    - name: "Step 2. Ensure journald persistent storage directory exists"
      ansible.builtin.file:
        path: "{{ kubeadm_pri.prereqs.paths.journald_log }}"
        state: directory
        mode: "0755"

    - name: "Step 3. Restart systemd-journald to apply persistent storage"
      ansible.builtin.systemd:
        name: systemd-journald
        state: restarted

    - name: "Step 4. Ensure kubelet service is enabled and running"
      ansible.builtin.systemd:
        name: kubelet
        state: started
        enabled: true

    - name: "Step 5. Ensure /etc/kubernetes directory exists"
      ansible.builtin.file:
        path: "{{ kubeadm_pri.prereqs.paths.kube_root }}"
        state: directory
        mode: "0755"

    - name: "Step 6. Create kubeadm config file from template"
      ansible.builtin.template:
        src: kubeadm-config.yaml.j2
        dest: "{{ kubeadm_pri.config.dest_path }}"
        mode: "0644"

- name: "Block B: Run kubeadm init to bootstrap the cluster"
  block:
    - name: "Step 1. Check if admin.conf already exists"
      ansible.builtin.stat:
        path: "{{ kubeadm_pri.kubeconfig.path }}"
      register: admin_conf_stat

    - name: "Step 2. Run kubeadm init command"
      ansible.builtin.shell: >-
        kubeadm init
        --config="{{kubeadm_pri.config.dest_path}}" 
        --upload-certs
        --ignore-preflight-errors=Port-6443
        > {{ kubeadm_pri.init.log_path }} 2>&1
      args:
        creates: "{{ kubeadm_pri.kubeconfig.path }}"
      when: not admin_conf_stat.stat.exists
      register: kubeadm_pri_result
      changed_when: kubeadm_pri_result.rc == 0
      notify: Restart haproxy on primary master

    - name: "Step 3. Verify that admin.conf was created"
      ansible.builtin.stat:
        path: "{{ kubeadm_pri.kubeconfig.path }}"
      register: admin_conf_stat_post_init

    - name: "Step 4. Fail if kubeadm init did not create admin.conf"
      ansible.builtin.fail:
        msg: "kubeadm init failed to create {{ kubeadm_pri.kubeconfig.path }}. Check {{ kubeadm_pri.init.log_path }} for details."
      when: not admin_conf_stat_post_init.stat.exists and kubeadm_pri_result is changed

- name: "Block C: Set up kubeconfig to enable kubectl"
  block:
    - name: "Step 1. Create .kube directory for the root user"
      ansible.builtin.file:
        path: "{{ kubeadm_pri.kubeconfig.root_setup.dir }}"
        state: directory
        mode: "{{ kubeadm_pri.kubeconfig.root_setup.dir_mode }}"

    - name: "Step 2. Copy admin.conf to root's kube config"
      ansible.builtin.copy:
        src: "{{ kubeadm_pri.kubeconfig.path }}"
        dest: "{{ kubeadm_pri.kubeconfig.root_setup.config_path }}"
        remote_src: true
        mode: "{{ kubeadm_pri.kubeconfig.root_setup.config_mode }}"

    - name: "Step 3. Create .kube directory for the SSH user"
      ansible.builtin.file:
        path: "{{ _kubeadm_pri_user_kube_dir }}"
        state: directory
        owner: "{{ ansible_ssh_user }}"
        group: "{{ ansible_ssh_user }}"
        mode: "{{ kubeadm_pri.kubeconfig.user_setup.dir_mode }}"

    - name: "Step 4. Copy admin.conf to user's kube config"
      ansible.builtin.copy:
        src: "{{ kubeadm_pri.kubeconfig.path }}"
        dest: "{{ _kubeadm_pri_user_kube_config }}"
        remote_src: true
        owner: "{{ ansible_ssh_user }}"
        group: "{{ ansible_ssh_user }}"
        mode: "{{ kubeadm_pri.kubeconfig.user_setup.config_mode }}"

- name: "Block D: Register kubeconfig content as a fact"
  block:
    - name: "Step 1. Fetch admin.conf to a predictable local path"
      ansible.builtin.fetch:
        src: "{{ kubeadm_pri.kubeconfig.path }}"
        dest: "{{ _kubeadm_pri_fetch_dest_path }}"
        flat: "{{ kubeadm_pri.fetch.flat }}"
