
# IMPORTANT: 
# * Dev Environment: The Private Key is injected from Terraform and write into State **for convenient**
# * Prod Environment: Terraform only reads the manually pre-injected file, where the Private Key will not be generated by Terraform.

tls_mode = "generated"

vault_compute = {
  cluster_identity = {
    service_name = "vault"
    component    = "core"
    cluster_name = "10-vault-core"
  }

  vault_cluster = {
    nodes = {
      # Single Mode
      "vault-node-00" = { ip = "172.16.136.200", vcpu = 2, ram = 1024 },
      # Uncomment the following lines for HA setup, abide by node % 2 != 0.
      # "vault-node-01" = { ip = "172.16.136.201", vcpu = 2, ram = 1024 },
      # "vault-node-02" = { ip = "172.16.136.202", vcpu = 2, ram = 1024 },
      # ...
    }
    base_image_path = "../../../packer/output/07-base-vault/ubuntu-server-24-07-base-vault.qcow2"
  }

  haproxy_config = {
    virtual_ip = "172.16.136.250"
    nodes = {
      "vault-haproxy-node-00" = { ip = "172.16.136.210", vcpu = 1, ram = 512 }
    }
    base_image_path = "../../../packer/output/08-base-haproxy/ubuntu-server-24-08-base-haproxy.qcow2"
  }
}

vault_infra = {
  network = {
    nat = {
      gateway = "172.16.88.1"
      cidrv4  = "172.16.88.0/24"
      dhcp = {
        start = "172.16.88.2"
        end   = "172.16.88.254"
      }
    }
    hostonly = {
      gateway = "172.16.136.1"
      cidrv4  = "172.16.136.0/24"
    }
  }
  allowed_subnet = "172.16.136.0/24"
}

service_topology = {
  root_domain = "iac.local"
  platforms   = ["gitlab", "harbor"]

  database_services = {
    types = {
      postgres = { prefixes = ["pg"] }
      redis    = { prefixes = ["redis"] }
      minio    = { prefixes = ["s3", "console"] }
    }
    max_ttl = 60 * 60 * 24 * 90 # 90 Days
    ttl     = 60 * 60 * 24      # 1 Day
  }

  ingress_services = {
    "gitlab" = {
      subdomains = ["gitlab", "kas", "registry", "minio"]
      max_ttl    = 60 * 60 * 24 * 90 # 90 Days
      ttl        = 60 * 60 * 24      # 1 Day
    }
    "harbor" = {
      subdomains = ["harbor", "notary"]
      max_ttl    = 60 * 60 * 24 * 90
      ttl        = 60 * 60 * 24
    }
    "dev-harbor" = {
      subdomains = ["dev-harbor", "notary.dev-harbor"]
      max_ttl    = 60 * 60 * 24 * 30
      ttl        = 60 * 60 * 24
    }
  }
}

vault_auth_backends = {
  "approle" = {
    type = "approle"
    path = "approle"
  }
  "kubernetes" = {
    type = "kubernetes"
    path = "kubernetes"
  }
}

vault_pki_engine_config = {
  path                = "pki/prod"
  root_ca_common_name = "on-premise-gitlab-deployment-root-ca"

  default_lease_ttl_seconds = 60 * 60 * 24       # 1 Day
  max_lease_ttl_seconds     = 60 * 60 * 24 * 365 # 1 Year
}
